name: Daily Video Monitor

on:
  schedule:
    # Runs every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:  # Manual trigger

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install python-telegram-bot python-dotenv supabase httpx

    - name: Run monitor (one-time check)
      env:
        MONITOR_BOT_TOKEN: ${{ secrets.MONITOR_BOT_TOKEN }}
        MONITOR_CHAT_ID: ${{ secrets.MONITOR_CHAT_ID }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        DAILY_VIDEO_PARENT_FOLDER: ${{ secrets.DAILY_VIDEO_PARENT_FOLDER }}
      run: |
        python -c "
        import asyncio
        from daily_video_monitor import DailyVideoMonitor
        from datetime import datetime, timedelta

        async def single_check():
            monitor = DailyVideoMonitor()
            tomorrow = (datetime.now() + timedelta(days=1)).date()
            print(f'Checking videos for {tomorrow}...')

            incomplete = monitor.supabase.get_incomplete_videos(tomorrow)

            if incomplete:
                # Build and send notification
                message = f'‚ö†Ô∏è **{tomorrow} Video Status**\n\n'
                by_channel = {}
                for video in incomplete:
                    channel = video['channel_code']
                    if channel not in by_channel:
                        by_channel[channel] = []
                    by_channel[channel].append(video)

                for channel in ['BI', 'AFG', 'JIMMY', 'GYH', 'ANU', 'JM']:
                    if channel in by_channel:
                        message += f'**{channel}:**\n'
                        for v in by_channel[channel]:
                            num = v['video_number']
                            status = monitor._get_missing_item(v)
                            message += f'  Video {num}: {status}\n'
                        message += '\n'

                stats = monitor.supabase.get_date_completion_stats(tomorrow)
                message += f'üìä {stats[\"completed\"]}/24 complete ({stats[\"percentage\"]}%)'

                await monitor.bot.send_message(
                    chat_id=monitor.chat_id,
                    text=message,
                    parse_mode='Markdown'
                )
                print(f'‚úÖ Notification sent: {len(incomplete)} incomplete items')
            else:
                print(f'‚úÖ All videos complete')

        asyncio.run(single_check())
        "
